{"ast":null,"code":"import _regeneratorRuntime from\"D:/Gitlab/dinhngocliennhi1999_frontend/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _asyncToGenerator from\"D:/Gitlab/dinhngocliennhi1999_frontend/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"D:/Gitlab/dinhngocliennhi1999_frontend/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _objectSpread from\"D:/Gitlab/dinhngocliennhi1999_frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import{createContext,useReducer,useEffect}from\"react\";import apiService from\"../app/apiService\";import{isValidToken}from\"../utils/jwt\";import{useSelector}from\"react-redux\";import{jsx as _jsx}from\"react/jsx-runtime\";var initialState={isAuthenticated:false,isInitialized:false,user:null};var INITIALIZE=\"INITIALIZE\";var LOGIN_SUCCESS=\"LOGIN_SUCCESS\";var REGISTER_SUCCESS=\"AUTH.REGISTER_SUCCESS\";var LOGOUT=\"LOGOUT\";var UPDATE_PROFILE=\"AUTH.UPDATE_PROFILE\";var reducer=function reducer(state,action){switch(action.type){case INITIALIZE:var _action$payload=action.payload,isAuthenticated=_action$payload.isAuthenticated,user=_action$payload.user;return _objectSpread(_objectSpread({},state),{},{isAuthenticated:isAuthenticated,isInitialized:true,user:user});case LOGIN_SUCCESS:return _objectSpread(_objectSpread({},state),{},{isAuthenticated:true,user:action.payload.user});case LOGOUT:return _objectSpread(_objectSpread({},state),{},{isAuthenticated:false,user:null});case UPDATE_PROFILE:var _action$payload2=action.payload,name=_action$payload2.name,avatarUrl=_action$payload2.avatarUrl,address=_action$payload2.address,city=_action$payload2.city,country=_action$payload2.country,phone=_action$payload2.phone,logoUrl=_action$payload2.logoUrl,storeName=_action$payload2.storeName,company=_action$payload2.company;return _objectSpread(_objectSpread({},state),{},{user:_objectSpread(_objectSpread({},state.user),{},{name:name,avatarUrl:avatarUrl,address:address,city:city,country:country,phone:phone,logoUrl:logoUrl,storeName:storeName,company:company})});default:return state;}};var AuthContext=/*#__PURE__*/createContext(_objectSpread({},initialState));// save accessToken\nvar setSession=function setSession(accessToken){if(accessToken){window.localStorage.setItem(\"accessToken\",accessToken);apiService.defaults.headers.common.Authorization=\"Bearer \".concat(accessToken);}else{window.localStorage.removeItem(\"accessToken\");delete apiService.defaults.headers.common.Authorization;}};function AuthProvider(_ref){var children=_ref.children;var _useReducer=useReducer(reducer,initialState),_useReducer2=_slicedToArray(_useReducer,2),state=_useReducer2[0],dispatch=_useReducer2[1];var updatedProfile=useSelector(function(state){return state.user.updatedProfile;});useEffect(function(){var initialize=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(){var accessToken,response,user;return _regeneratorRuntime().wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;accessToken=window.localStorage.getItem(\"accessToken\");if(!(accessToken&&isValidToken(accessToken))){_context.next=11;break;}setSession(accessToken);_context.next=6;return apiService.get(\"/users/me\");case 6:response=_context.sent;user=response.data;// console.log(\"user\", response.data.data);\ndispatch({type:INITIALIZE,payload:{isAuthenticated:true,user:user}});_context.next=13;break;case 11:setSession(null);dispatch({type:INITIALIZE,payload:{isAuthenticated:false,user:null}});case 13:_context.next=20;break;case 15:_context.prev=15;_context.t0=_context[\"catch\"](0);console.error(_context.t0);setSession(null);dispatch({type:INITIALIZE,payload:{isAuthenticated:false,user:null}});case 20:case\"end\":return _context.stop();}}},_callee,null,[[0,15]]);}));return function initialize(){return _ref2.apply(this,arguments);};}();initialize();},[]);useEffect(function(){if(updatedProfile)dispatch({type:UPDATE_PROFILE,payload:updatedProfile});},[updatedProfile]);var login=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(_ref3,callback){var email,password,response,_response$data,user,accessToken;return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:email=_ref3.email,password=_ref3.password;_context2.next=3;return apiService.post(\"/auth/login\",{email:email,password:password});case 3:response=_context2.sent;_response$data=response.data,user=_response$data.user,accessToken=_response$data.accessToken;setSession(accessToken);dispatch({type:LOGIN_SUCCESS,payload:{user:user}});callback();case 8:case\"end\":return _context2.stop();}}},_callee2);}));return function login(_x,_x2){return _ref4.apply(this,arguments);};}();var register=/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee3(_ref5,callback){var name,email,password,response,_response$data2,user,accessToken;return _regeneratorRuntime().wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:name=_ref5.name,email=_ref5.email,password=_ref5.password;_context3.next=3;return apiService.post(\"/users/customer\",{name:name,email:email,password:password});case 3:response=_context3.sent;_response$data2=response.data,user=_response$data2.user,accessToken=_response$data2.accessToken;setSession(accessToken);dispatch({type:REGISTER_SUCCESS,payload:{user:user}});callback();case 8:case\"end\":return _context3.stop();}}},_callee3);}));return function register(_x3,_x4){return _ref6.apply(this,arguments);};}();var logout=function logout(callback){setSession(null);dispatch({type:LOGOUT});callback();};return/*#__PURE__*/_jsx(AuthContext.Provider,{value:_objectSpread(_objectSpread({},state),{},{login:login,register:register,logout:logout,updatedProfile:updatedProfile}),children:children});}export{AuthContext,AuthProvider};","map":{"version":3,"names":["createContext","useReducer","useEffect","apiService","isValidToken","useSelector","initialState","isAuthenticated","isInitialized","user","INITIALIZE","LOGIN_SUCCESS","REGISTER_SUCCESS","LOGOUT","UPDATE_PROFILE","reducer","state","action","type","payload","name","avatarUrl","address","city","country","phone","logoUrl","storeName","company","AuthContext","setSession","accessToken","window","localStorage","setItem","defaults","headers","common","Authorization","removeItem","AuthProvider","children","dispatch","updatedProfile","initialize","getItem","get","response","data","console","error","login","callback","email","password","post","register","logout"],"sources":["D:/Gitlab/dinhngocliennhi1999_frontend/src/contexts/AuthContext.js"],"sourcesContent":["import { createContext, useReducer, useEffect } from \"react\";\r\nimport apiService from \"../app/apiService\";\r\nimport { isValidToken } from \"../utils/jwt\";\r\nimport { useSelector } from \"react-redux\";\r\n\r\nconst initialState = {\r\n  isAuthenticated: false,\r\n  isInitialized: false,\r\n  user: null,\r\n};\r\n\r\nconst INITIALIZE = \"INITIALIZE\";\r\nconst LOGIN_SUCCESS = \"LOGIN_SUCCESS\";\r\nconst REGISTER_SUCCESS = \"AUTH.REGISTER_SUCCESS\";\r\nconst LOGOUT = \"LOGOUT\";\r\nconst UPDATE_PROFILE = \"AUTH.UPDATE_PROFILE\";\r\n\r\nconst reducer = (state, action) => {\r\n  switch (action.type) {\r\n    case INITIALIZE:\r\n      const { isAuthenticated, user } = action.payload;\r\n      return {\r\n        ...state,\r\n        isAuthenticated,\r\n        isInitialized: true,\r\n        user,\r\n      };\r\n    case LOGIN_SUCCESS:\r\n      return {\r\n        ...state,\r\n        isAuthenticated: true,\r\n        user: action.payload.user,\r\n      };\r\n    case LOGOUT:\r\n      return {\r\n        ...state,\r\n        isAuthenticated: false,\r\n        user: null,\r\n      };\r\n    case UPDATE_PROFILE:\r\n      const {\r\n        name,\r\n        avatarUrl,\r\n        address,\r\n        city,\r\n        country,\r\n        phone,\r\n        logoUrl,\r\n        storeName,\r\n        company,\r\n      } = action.payload;\r\n      return {\r\n        ...state,\r\n        user: {\r\n          ...state.user,\r\n          name,\r\n          avatarUrl,\r\n          address,\r\n          city,\r\n          country,\r\n          phone,\r\n          logoUrl,\r\n          storeName,\r\n          company,\r\n        },\r\n      };\r\n    default:\r\n      return state;\r\n  }\r\n};\r\n\r\nconst AuthContext = createContext({ ...initialState });\r\n// save accessToken\r\nconst setSession = (accessToken) => {\r\n  if (accessToken) {\r\n    window.localStorage.setItem(\"accessToken\", accessToken);\r\n    apiService.defaults.headers.common.Authorization = `Bearer ${accessToken}`;\r\n  } else {\r\n    window.localStorage.removeItem(\"accessToken\");\r\n    delete apiService.defaults.headers.common.Authorization;\r\n  }\r\n};\r\n\r\nfunction AuthProvider({ children }) {\r\n  const [state, dispatch] = useReducer(reducer, initialState);\r\n  const updatedProfile = useSelector((state) => state.user.updatedProfile);\r\n\r\n  useEffect(() => {\r\n    const initialize = async () => {\r\n      try {\r\n        const accessToken = window.localStorage.getItem(\"accessToken\");\r\n\r\n        if (accessToken && isValidToken(accessToken)) {\r\n          setSession(accessToken);\r\n\r\n          const response = await apiService.get(\"/users/me\");\r\n          const user = response.data;\r\n          // console.log(\"user\", response.data.data);\r\n          dispatch({\r\n            type: INITIALIZE,\r\n            payload: { isAuthenticated: true, user },\r\n          });\r\n        } else {\r\n          setSession(null);\r\n\r\n          dispatch({\r\n            type: INITIALIZE,\r\n            payload: { isAuthenticated: false, user: null },\r\n          });\r\n        }\r\n      } catch (err) {\r\n        console.error(err);\r\n\r\n        setSession(null);\r\n        dispatch({\r\n          type: INITIALIZE,\r\n          payload: {\r\n            isAuthenticated: false,\r\n            user: null,\r\n          },\r\n        });\r\n      }\r\n    };\r\n\r\n    initialize();\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (updatedProfile)\r\n      dispatch({ type: UPDATE_PROFILE, payload: updatedProfile });\r\n  }, [updatedProfile]);\r\n\r\n  const login = async ({ email, password }, callback) => {\r\n    const response = await apiService.post(\"/auth/login\", { email, password });\r\n    const { user, accessToken } = response.data;\r\n    setSession(accessToken);\r\n    dispatch({\r\n      type: LOGIN_SUCCESS,\r\n      payload: { user },\r\n    });\r\n\r\n    callback();\r\n  };\r\n\r\n  const register = async ({ name, email, password }, callback) => {\r\n    const response = await apiService.post(\"/users/customer\", {\r\n      name,\r\n      email,\r\n      password,\r\n    });\r\n    const { user, accessToken } = response.data;\r\n\r\n    setSession(accessToken);\r\n    dispatch({\r\n      type: REGISTER_SUCCESS,\r\n      payload: { user },\r\n    });\r\n\r\n    callback();\r\n  };\r\n\r\n  const logout = (callback) => {\r\n    setSession(null);\r\n    dispatch({\r\n      type: LOGOUT,\r\n    });\r\n    callback();\r\n  };\r\n\r\n  return (\r\n    <AuthContext.Provider\r\n      value={{\r\n        ...state,\r\n        login,\r\n        register,\r\n        logout,\r\n        updatedProfile,\r\n      }}\r\n    >\r\n      {children}\r\n    </AuthContext.Provider>\r\n  );\r\n}\r\n\r\nexport { AuthContext, AuthProvider };\r\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}